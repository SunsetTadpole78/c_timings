<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>C Timings Viewer</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<style>
		body {
			font-family: sans-serif;
			padding: 20px;
			background-color: #f4f4f4;
			margin: 0;
		}

		textarea {
			width: 100%;
			max-width: 600px;
			height: 150px;
			font-family: monospace;
			margin-bottom: 20px;
			resize: vertical;
		}

		#resultTable {
			border-collapse: collapse;
			width: 100%;
			background-color: white;
			overflow-x: auto;
		}

		#resultTable th,
		#resultTable td {
			border: 1px solid #ccc;
			padding: 8px;
			text-align: left;
			transition: background-color 0.3s;
		}

		#resultTable th {
			background-color: #eee;
			cursor: pointer;
			user-select: none;
			position: relative;
		}

		#resultTable th:hover {
			background-color: #ddd;
		}

		#resultTable th.sorted-asc::after {
			content: " ▲";
			position: absolute;
			right: 8px;
			font-size: 0.7em;
		}

		#resultTable th.sorted-desc::after {
			content: " ▼";
			position: absolute;
			right: 8px;
			font-size: 0.7em;
		}

		#sampleTime {
			text-align: center;
			margin: 10px 0;
		}

		footer {
			text-align: right;
			background-color: #f4f4f4;
			margin-top: 40px;
			padding: 10px 20px;
		}

		hr {
			border: none;
			border-top: 1px solid #ccc;
			margin: 40px 0;
		}

		#inputImportWrapper {
			display: flex;
			justify-content: center;
			flex-wrap: wrap;
			margin-bottom: 30px;
		}

		.input-block {
			display: flex;
			flex-direction: column;
			align-items: center;
			width: 100%;
			max-width: 600px;
		}

		.button-group {
			display: flex;
			justify-content: center;
			gap: 10px;
			flex-wrap: wrap;
			margin-top: 10px;
		}

		button {
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 4px;
			padding: 8px 16px;
			cursor: pointer;
			font-size: 14px;
			transition: background-color 0.3s;
		}

		button:hover {
			background-color: #45a049;
		}

		#fileInput {
			display: none;
		}

		@media (max-width: 600px) {
			.button-group {
				flex-direction: column;
				width: 100%;
			}

			button {
				width: 100%;
			}
		}
	</style>
</head>
<body>
	<center>
		<h1>C Timings Viewer</h1>
		<div id="inputImportWrapper">
			<div class="input-block">
				<p><strong>Paste your timings below:</strong></p>
				<textarea id="input" placeholder="Paste the timing data here..."></textarea>
				<div class="button-group">
					<button onclick="parseTimings()">Analyze</button>
					<button id="loadBtn">Load File</button>
					<input type="file" id="fileInput" accept=".ctmg" />
				</div>
			</div>
		</div>
	</center>

	<hr />

	<div id="sampleTime"></div>
	<div style="overflow-x: auto;">
		<table id="resultTable">
			<thead>
				<tr>
					<th>Event</th>
					<th>% Total</th>
					<th>Time ÷ Count</th>
					<th>Count</th>
				</tr>
			</thead>
			<tbody></tbody>
		</table>
	</div>

	<script>
		let currentSortColumn = 0;
		let currentSortAsc = true;

		function convertNanoseconds(value) {
			const ns = Number(value);
			let res = ns;
			let unit = "μs";

			if (res > 86400000000.0) {
				res /= 86400000000.0;
				unit = "d";
			} else if (res > 3600000000.0) {
				res /= 3600000000.0;
				unit = "h";
			} else if (res > 60000000.0) {
				res /= 60000000.0;
				unit = "m";
			} else if (res > 1000000.0) {
				res /= 1000000.0;
				unit = "s";
			} else if (res > 1000.0) {
				res /= 1000.0;
				unit = "ms";
			}
			return `${res.toFixed(2)}${unit}`;
		}

		function timeToNs(timeStr) {
			const units = { d: 86400000000000, h: 3600000000000, m: 60000000000, s: 1000000000, ms: 1000000, μs: 1000 };
			const match = timeStr.match(/^([\d.]+)([a-zμ]+)$/i);
			if (!match) return NaN;
			let [_, num, unit] = match;
			unit = unit.toLowerCase();
			if (unit === 'us') unit = 'μs';
			const factor = units[unit] || 1;
			return parseFloat(num) * factor;
		}

		function getHeatColor(percent) {
			const p = Math.min(Math.max(percent, 0), 100);
			let r = 255, g = 255, b = 255;

			if (p <= 25) {
				const t = p / 25;
				r = 255;
				g = 255;
				b = 255 - (t * 102);
			} else if (p <= 50) {
				const t = (p - 25) / 25;
				r = 255;
				g = 255;
				b = 153 - (t * 153);
			} else if (p <= 75) {
				const t = (p - 50) / 25;
				r = 255;
				g = 255 - (t * 102);
				b = 0;
			} else {
				const t = (p - 75) / 25;
				r = 255;
				g = 153 - (t * 153);
				b = 0;
			}
			return `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`;
		}

		function parseTimings() {
			const input = document.getElementById('input').value.trim();
			const lines = input.split('\n');
			const tbody = document.querySelector('#resultTable tbody');
			const sampleDiv = document.getElementById('sampleTime');
			tbody.innerHTML = '';
			sampleDiv.textContent = '';

			if (lines.length < 2) {
				alert('Invalid timing format: must have at least 2 lines.');
				return;
			}

			const sampleLine = lines[0].trim();
			if (!/^\d+$/.test(sampleLine)) {
				alert('First line must be a single integer (sample time in nanoseconds).');
				return;
			}

			const sampleTime = parseInt(sampleLine);
			sampleDiv.innerHTML = `<strong>Sample Time:</strong> ${convertNanoseconds(sampleTime)}`;

			for (let i = 1; i < lines.length; i++) {
				const line = lines[i].trim();
				if (line.length === 0) continue;

				const parts = line.split(",");
				if (parts.length !== 3) {
					alert(`Invalid format at line ${i + 1}. Expected 3 values.`);
					return;
				}

				const [event, totalTimeStr, countStr] = parts;

				if (!/^\d+$/.test(totalTimeStr) || !/^\d+$/.test(countStr)) {
					alert(`Line ${i + 1}: Total Time and Count must be integers.`);
					return;
				}

				const totalTime = parseInt(totalTimeStr);
				const count = parseInt(countStr);
				const percentValue = (totalTime / sampleTime) * 100;
				const percent = percentValue.toFixed(2) + '%';
				const timePerCall = convertNanoseconds(totalTime / count);

				const row = document.createElement('tr');
				row.innerHTML = `
					<td>${event}</td>
					<td style="background-color:${getHeatColor(percentValue)}">${percent}</td>
					<td>${timePerCall}</td>
					<td>${count}</td>
				`;
				tbody.appendChild(row);
			}

			sortTableByColumn(0, true);
		}

		function sortTableByColumn(index, forceAsc = null) {
			const tbody = document.querySelector('#resultTable tbody');
			const rows = Array.from(tbody.querySelectorAll('tr'));

			if (forceAsc !== null) {
				currentSortAsc = forceAsc;
			} else {
				currentSortAsc = currentSortColumn === index ? !currentSortAsc : index == 0;
			}
			currentSortColumn = index;

			rows.sort((a, b) => {
				let aText = a.children[index].textContent;
				let bText = b.children[index].textContent;

				let aVal, bVal;

				if (index === 1) {
					aVal = parseFloat(aText.replace('%', ''));
					bVal = parseFloat(bText.replace('%', ''));
				} else if (index === 2) {
					aVal = timeToNs(aText);
					bVal = timeToNs(bText);
				} else if (index === 3) {
					aVal = parseInt(aText);
					bVal = parseInt(bText);
				} else {
					aVal = aText.toLowerCase();
					bVal = bText.toLowerCase();
				}

				return (aVal < bVal ? -1 : aVal > bVal ? 1 : 0) * (currentSortAsc ? 1 : -1);
			});

			tbody.innerHTML = '';
			rows.forEach(row => tbody.appendChild(row));

			document.querySelectorAll('#resultTable th').forEach((th, idx) => {
				th.classList.remove('sorted-asc', 'sorted-desc');
				if (idx === currentSortColumn) {
					th.classList.add(currentSortAsc ? 'sorted-asc' : 'sorted-desc');
				}
			});
		}

		document.querySelectorAll('#resultTable th').forEach((th, idx) => {
			th.addEventListener('click', () => sortTableByColumn(idx));
		});

		document.getElementById('loadBtn').addEventListener('click', () => {
			document.getElementById('fileInput').click();
		});

		document.getElementById('fileInput').addEventListener('change', () => {
			const fileInput = document.getElementById('fileInput');
			if (fileInput.files.length === 0) {
				alert('No file selected.');
				return;
			}
			const reader = new FileReader();
			reader.onload = function(e) {
				document.getElementById('input').value = e.target.result;
				parseTimings();
			};
			reader.readAsText(fileInput.files[0]);
		});
	</script>

	<footer>
		<hr />
		<h4>~Sunset</h4>
	</footer>
</body>
</html>
